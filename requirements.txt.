# app.py
streamlit
pandas
numpy
scipy
plotly 
# Application Streamlit pour collecte & analyse de la fiche d'enquête
# Usage:
#  pip install streamlit pandas plotly openpyxl scipy
#  streamlit run app.py

import streamlit as st
import pandas as pd
import os
from datetime import datetime
import plotly.express as px
from scipy import stats

# --- Config ---
DATA_DIR = "data"
DATA_FILE = os.path.join(DATA_DIR, "responses.csv")
if not os.path.exists(DATA_DIR):
    os.makedirs(DATA_DIR)

st.set_page_config(page_title="Fiche d'enquête - Prévention cancer du sein", layout="wide")

st.title("Fiche de collecte -- Prévention du cancer du sein (HGRM)")
st.markdown("Application de saisie et d'analyse des enquêtes. Remplis la fiche à gauche, visualise et analyse les réponses à droite.")

# --- Helper: default columns to match la fiche ---
def get_columns():
    cols = [
        "timestamp",
        "code_enquete",
        "date_enquete",
        "service",
        "enqueteur",
        "consentement",  # Oui/Non
        # sociodemo
        "sexe",
        "age",
        "etat_civil",
        "niveau_etudes",
        "annees_experience",
        "statut_professionnel",
        "service_affectation",
        "antecedents_cancer_personnel_familial",
        "antecedents_detail",
        # connaissances (True/False/NA)
        "k_age",
        "k_obesite",
        "k_antec_familiaux",
        "k_autopalpation",
        "k_examen_clinique",
        "k_mammographie",
        "k_age_depistage",
        "k_mammographie_remplace",
        # examen de dépistage
        "disp_mammographie",
        "sait_ou_referer",
        "frequence_examen_clinique",
        "echographie_usage",
        "sait_expliquer_mammo",
        "sait_expliquer_exam_clinique",
        # attitudes (1-5)
        "att_priorite",
        "att_aise_autopalpation",
        "att_examen_systematique",
        "att_cout_obstacle",
        "att_patientes_receptives",
        "att_capacite_recommander",
        # pratiques
        "pratique_autopalpation",
        "pratique_autopalpation_freq",
        "realise_exam_clinique",
        "informe_signes_precoces",
        "enseigne_autopalpation",
        "reference_mammographie",
        "participe_sensibilisation",
        # obstacles (list)
        "obstacles",
        # recommandations
        "besoin_formation",
        "type_formation",
        "suggestions"
    ]
    return cols

# --- Load existing responses if any ---
def load_data():
    if os.path.exists(DATA_FILE):
        df = pd.read_csv(DATA_FILE)
    else:
        df = pd.DataFrame(columns=get_columns())
    return df

def save_response(row: dict):
    df = load_data()
    df = df.append(row, ignore_index=True)
    df.to_csv(DATA_FILE, index=False)

# --- Sidebar: Form ---
st.sidebar.header("Saisir une fiche")
with st.sidebar.form(key="enquete_form"):
    st.subheader("Identification")
    code_enquete = st.text_input("Code de l'enquêtée")
    date_enquete = st.date_input("Date de l'enquête", value=datetime.today())
    service = st.text_input("Service")
    enqueteur = st.text_input("Enquêteur(trice)")

    st.subheader("Consentement")
    consent = st.radio("Consentement éclairé", ("J’accepte", "Je refuse"))

    st.subheader("Données sociodémographiques")
    sexe = st.radio("Sexe", ("Femme", "Homme"))
    age = st.number_input("Âge (ans)", min_value=16, max_value=100, value=30)
    etat_civil = st.selectbox("État civil", ("Célibataire", "Mariée", "Autre"))
    niveau_etudes = st.selectbox("Niveau d'études", ("Infirmière diplômée", "Licence", "Master", "Autre"))
    annees_experience = st.number_input("Années d'expérience", min_value=0, max_value=60, value=1)
    statut_professionnel = st.selectbox("Statut professionnel", ("Titulaire", "Contractuelle", "Stagiaire", "Autre"))
    service_affectation = st.text_input("Service d'affectation")
    antec_cancer = st.radio("Antécédents personnels/familiaux de cancer du sein", ("Oui", "Non"))
    antec_detail = st.text_input("Préciser si oui (antécédent)")

    st.subheader("Connaissances (Vrai/Faux)")
    def vf_radio(label): return st.radio(label, ("Vrai", "Faux"))
    k_age = vf_radio("Le risque augmente avec l'âge")
    k_obesite = vf_radio("L'obésité est un facteur de risque")
    k_antec_familiaux = vf_radio("Les antécédents familiaux augmentent le risque")
    k_autopalpation = vf_radio("L'autopalpation détecte des anomalies précoces")
    k_examen_clinique = vf_radio("L'examen clinique est efficace")
    k_mammographie = vf_radio("La mammographie est un examen de dépistage secondaire")
    k_age_depistage = st.number_input("À partir de quel âge conseille-t-on mammographie ?", min_value=0, max_value=100, value=40)
    k_mammographie_remplace = vf_radio("La mammographie remplace l'examen clinique")

    st.subheader("Connaissances sur examens")
    disp_mammo = st.selectbox("Structure dispose d'un service de mammographie ?", ("Oui", "Non", "Je ne sais pas"))
    sait_referer = st.radio("Savez-vous où référer les patientes ?", ("Oui", "Non"))
    frequence_examen = st.selectbox("Fréquence examen clinique", ("Chaque année", "Tous les 2 ans", "Je ne sais pas"))
    echo_usage = st.selectbox("L'échographie mammaire est utilisée :", ("En complément", "En première intention chez les femmes jeunes", "Je ne sais pas"))
    sait_expliquer_mammo = st.radio("Savez-vous expliquer l'utilité de la mammographie ?", ("Oui", "Non"))
    sait_expliquer_exam = st.radio("Savez-vous expliquer le déroulement de l'examen clinique ?", ("Oui", "Non"))

    st.subheader("Attitudes (1-5)")
    att_priorite = st.slider("La prévention est une priorité", 1, 5, 4)
    att_aise = st.slider("Je suis à l'aise pour expliquer l'autopalpation", 1, 5, 3)
    att_systematique = st.slider("L'examen devrait être systématique chez les femmes à risque", 1, 5, 4)
    att_cout_obstacle = st.slider("Le coût constitue un obstacle majeur", 1, 5, 4)
    att_patientes_receptives = st.slider("Les patientes sont réceptives", 1, 5, 3)
    att_capacite = st.slider("Je me sens capable de recommander un dépistage adapté", 1, 5, 3)

    st.subheader("Pratiques")
    pratique_auto = st.radio("Pratique personnelle de l'autopalpation", ("Oui", "Non"))
    pratique_auto_freq = st.selectbox("Fréquence", ("Mensuelle", "Occasionnelle", "Rare"))
    realise_exam_clinique = st.selectbox("Réalisez-vous un examen clinique lors des consultations ?", ("Toujours", "Parfois", "Jamais"))
    informe_signes = st.radio("Informez-vous les patientes sur les signes précoces ?", ("Oui", "Non", "Parfois"))
    enseigne_auto = st.radio("Enseignez-vous l'autopalpation ?", ("Oui", "Non"))
    reference_mammo = st.radio("Référencez-vous pour mammographie ?", ("Oui", "Non"))
    participe_sens = st.radio("Avez-vous participé à une activité de sensibilisation ?", ("Oui", "Non"))

    st.subheader("Obstacles (cochez ceux qui s'appliquent)")
    obst_options = ["Manque de matériel", "Manque de formation", "Manque de temps", "Coût élevé des examens",
                    "Distance vers les centres", "Tabous culturels", "Manque d'information des patientes",
                    "Surcharge de travail", "Autres"]
    obstacles_selected = st.multiselect("Obstacles", obst_options)
    autres_obstacles = ""
    if "Autres" in obstacles_selected:
        autres_obstacles = st.text_input("Précisez autres obstacles")

    st.subheader("Recommandations")
    besoin_formation = st.radio("Besoin de formation supplémentaire ?", ("Oui", "Non"))
    type_formation = st.selectbox("Quel type de formation ?", ("Licence", "Master", "Formation continue", "Autre"))
    suggestions = st.text_area("Suggestions pour améliorer la prévention")

    submit = st.form_submit_button("Enregistrer la fiche")

    if submit:
        row = {
            "timestamp": datetime.now().isoformat(),
            "code_enquete": code_enquete,
            "date_enquete": date_enquete.isoformat(),
            "service": service,
            "enqueteur": enqueteur,
            "consentement": consent,
            "sexe": sexe,
            "age": int(age),
            "etat_civil": etat_civil,
            "niveau_etudes": niveau_etudes,
            "annees_experience": int(annees_experience),
            "statut_professionnel": statut_professionnel,
            "service_affectation": service_affectation,
            "antecedents_cancer_personnel_familial": antec_cancer,
            "antecedents_detail": antec_detail,
            "k_age": k_age,
            "k_obesite": k_obesite,
            "k_antec_familiaux": k_antec_familiaux,
            "k_autopalpation": k_autopalpation,
            "k_examen_clinique": k_examen_clinique,
            "k_mammographie": k_mammographie,
            "k_age_depistage": int(k_age_depistage),
            "k_mammographie_remplace": k_mammographie_remplace,
            "disp_mammographie": disp_mammo,
            "sait_ou_referer": sait_referer,
            "frequence_examen_clinique": frequence_examen,
            "echographie_usage": echo_usage,
            "sait_expliquer_mammo": sait_expliquer_mammo,
            "sait_expliquer_exam_clinique": sait_expliquer_exam,
            "att_priorite": att_priorite,
            "att_aise_autopalpation": att_aise,
            "att_examen_systematique": att_systematique,
            "att_cout_obstacle": att_cout_obstacle,
            "att_patientes_receptives": att_patientes_receptives,
            "att_capacite_recommander": att_capacite,
            "pratique_autopalpation": pratique_auto,
            "pratique_autopalpation_freq": pratique_auto_freq,
            "realise_exam_clinique": realise_exam_clinique,
            "informe_signes_precoces": informe_signes,
            "enseigne_autopalpation": enseigne_auto,
            "reference_mammographie": reference_mammo,
            "participe_sensibilisation": participe_sens,
            "obstacles": "; ".join(obstacles_selected) + ("; " + autres_obstacles if autres_obstacles else ""),
            "besoin_formation": besoin_formation,
            "type_formation": type_formation,
            "suggestions": suggestions
        }
        save_response(row)
        st.success("Fiche enregistrée ✅")

# --- Main area: Visualisation & Analyses ---
st.header("Tableau de bord -- Données & analyses")

df = load_data()
st.write(f"Nombre de fiches collectées : **{len(df)}**")

col1, col2 = st.columns([1,1])

with col1:
    st.subheader("Données brutes")
    if len(df)==0:
        st.info("Aucune fiche enregistrée pour l'instant.")
    else:
        st.dataframe(df.sort_values("timestamp", ascending=False).reset_index(drop=True))
        st.download_button("Télécharger CSV", df.to_csv(index=False).encode('utf-8'), file_name="responses.csv", mime="text/csv")

with col2:
    st.subheader("Statistiques descriptives rapides")
    if len(df) > 0:
        # Age
        ages = df["age"].dropna().astype(int)
        st.metric("Âge moyen", f"{ages.mean():.1f} ans")
        st.metric("Âge médian", f"{ages.median():.0f} ans")
        st.write("Distribution d'âge :")
        fig_age = px.histogram(ages, nbins=10, labels={'value':'Âge'}, title="Histogramme des âges")
        st.plotly_chart(fig_age, use_container_width=True)

        # Sexe distribution
        st.write("Répartition par sexe :")
        fig_sex = px.pie(df, names="sexe", title="Sexe")
        st.plotly_chart(fig_sex, use_container_width=True)

        # Niveau d'études freq
        st.write("Niveau d'études (fréquences & %)")
        freq_niv = df["niveau_etudes"].value_counts(dropna=False).rename_axis('niveau').reset_index(name='count')
        freq_niv['percent'] = (freq_niv['count'] / freq_niv['count'].sum()*100).round(1).astype(str) + '%'
        st.table(freq_niv)

        # Connaissances: exemples (calcul % de 'Vrai' réponses)
        st.write("Connaissances -- % de réponses 'Vrai'")
        k_cols = ["k_age","k_obesite","k_antec_familiaux","k_autopalpation","k_examen_clinique","k_mammographie"]
        kn = {}
        for c in k_cols:
            if c in df.columns:
                total = df[c].notna().sum()
                if total>0:
                    true_count = (df[c]=="Vrai").sum()
                    kn[c] = {"Vrai": true_count, "Total": total, "Percent": f"{true_count/total*100:.1f}%"}
        kn_df = pd.DataFrame.from_dict(kn, orient='index')
        st.table(kn_df)

        # Likert: Moyennes et écarts-types
        likert_cols = ["att_priorite","att_aise_autopalpation","att_examen_systematique","att_cout_obstacle","att_patientes_receptives","att_capacite_recommander"]
        likert_stats = []
        for c in likert_cols:
            if c in df.columns:
                vals = pd.to_numeric(df[c], errors='coerce').dropna()
                if len(vals)>0:
                    likert_stats.append({"item": c, "mean": round(vals.mean(),2), "sd": round(vals.std(),2), "n": len(vals)})
        st.write("Attitudes (échelle 1-5) -- Moyenne & écart-type")
        st.table(pd.DataFrame(likert_stats).set_index("item"))

# --- Analyses personnalisées ---
st.subheader("Analyses & tableaux croisés")
if len(df) > 0:
    # Exemple: Connaissance 'k_mammographie' par niveau d'études
    st.markdown("**Connaissance : la mammographie est un examen de dépistage secondaire** -- par niveau d'études")
    ctab = pd.crosstab(df["niveau_etudes"], df["k_mammographie"], margins=True)
    st.table(ctab)

    # Chi-square test example (pourvoir de test si cell >=5)
    try:
        tbl = pd.crosstab(df["niveau_etudes"], df["k_mammographie"])
        if tbl.size>0 and (tbl.values >= 5).sum() >= 2:
            chi2, p, dof, ex = stats.chi2_contingency(tbl.fillna(0).values)
            st.write(f"Chi² = {chi2:.2f}, p = {p:.3f}, ddl = {dof}")
        else:
            st.info("Trop peu de données pour un test du Chi² fiable (cellules < 5).")
    except Exception as e:
        st.error(f"Erreur test statistique : {e}")

    # Histogramme d'un score composite (ex: somme des attitudes)
    st.markdown("**Score composite d'attitude (somme des items 1-5)**")
    df_scores = df.copy()
    for c in likert_cols:
        df_scores[c] = pd.to_numeric(df_scores[c], errors='coerce')
    df_scores['att_score'] = df_scores[likert_cols].sum(axis=1, skipna=True)
    fig_score = px.histogram(df_scores['att_score'].dropna(), nbins=15, labels={'value':'Score d\'attitude'}, title="Distribution du score d'attitude")
    st.plotly_chart(fig_score, use_container_width=True)

    # Croiser pratiques vs formation désirée
    st.markdown("**Pratique d'autopalpation vs besoin de formation**")
    ctab2 = pd.crosstab(df["pratique_autopalpation"], df["besoin_formation"], normalize='index')*100
    st.table(ctab2.round(1))

    # Export Excel (CSV déjà fourni) -- on crée un Excel simple
    if st.button("Exporter les données en Excel (.xlsx)"):
        out_file = os.path.join(DATA_DIR, "responses.xlsx")
        df.to_excel(out_file, index=False)
        with open(out_file, "rb") as f:
            st.download_button("Télécharger fichier Excel", f.read(), file_name="responses.xlsx", mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
else:
    st.info("Pas encore de données pour les analyses.")

st.markdown("---")
# Utilisation de balises <br> (HTML) ou de doubles sauts de ligne (Markdown)
st.markdown("""
### Notes & Instructions
- Les réponses sont sauvegardées en mémoire.
- Téléchargez le fichier CSV pour une sauvegarde permanente.
- Vous pouvez ajouter des visualisations plus poussées.
""")